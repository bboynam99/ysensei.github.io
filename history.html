<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="css/common.css" rel="stylesheet">
</head>
<body>
<nav>
    <div class="container-wide">
        <div class="row">
            <div class="col m3">
                <a href="javascript:;" class="logo">logo</a>
            </div>
            <div class="col m9">
                <div class="right">
                    <ul>
                        <li>
                            <a href="#h">如何投注</a>
                        </li>
                        <li>
                            <a href="#w">关于项目</a>
                        </li>
                        <li>
                            <a href="javascript:;">Telegram群</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
<div class="container">
    <table border="1" align="center">
        <tbody align="center">
        <!--<tr>-->
            <!--<th align="center">期号</th>-->
            <!--<th align="center">开奖时间</th>-->
            <!--<th align="center">中奖号码</th>-->
            <!--<th align="center">获奖者地址</th>-->
            <!--<th align="center">区块高度</th>-->
            <!--<th align="center">查看详情</th>-->
        <!--</tr>-->
        <!--<tr>-->
            <!--<td>127</td>-->
            <!--<td>2018年3月4日 15:45:25</td>-->
            <!--<td>893</td>-->
            <!--<td>0xced2faa1d2e10a43d98a04c3b505296cde6342c7</td>-->
            <!--<td>2761975</td>-->
            <!--<td><a href="javascript:;">view-more</a></td>-->
        <!--</tr>-->
        <!--<tr>-->
            <!--<td>127</td>-->
            <!--<td>2018年3月4日 15:45:25</td>-->
            <!--<td>893</td>-->
            <!--<td>0xced2faa1d2e10a43d98a04c3b505296cde6342c7</td>-->
            <!--<td>2761975</td>-->
            <!--<td>-->
                <!--<a href="javascript:;">view-more</a>-->
            <!--</td>-->
        <!--</tr>-->
        </tbody>
    </table>
</div>
<script charset="utf-8" src="https://cdn.ethers.io/scripts/ethers-v2.min.js" type="text/javascript"></script>
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="js/history.js"></script>

<script type="text/javascript">
    var _html = '<tr>' +
        '<th>期号</th>' +
        '<th>开奖时间</th>' +
        '<th>中奖号码</th>' +
        '<th>获奖者地址</th>' +
        '<th>区块高度</th>' +
        '<th>查看详情</th>' +
        '</tr>';
    function renderTable (num, time, prizeNum, address, height ,details ) {
        _html += '<tr>' +
            '<td>' + num + '</td>' +
            '<td>' + time + '</td>' +
            '<td>' + prizeNum + '</td>' +
            '<td>' + address + '</td>' +
            '<td>' + height + '</td>' +
            '<td><a href="'+details+'" target="_blank">查看详情</a></td>' +
            '</tr>';
        $('tbody').html(_html);
    }

    var contractAddress = '0x1a07369b3df4390d05189cc5bb0f9ad778cc7f7b';
    var abi = '[{"constant":true,"inputs":[],"name":"getCurrentPeriod","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"winnersResult","outputs":[{"name":"addr","type":"address"},{"name":"number","type":"uint256"},{"name":"blockNumber","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getCurrentNumber","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address"},{"name":"amount","type":"uint256"}],"name":"getEthers","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"pd","type":"uint256"}],"name":"getPrizeResult","outputs":[{"name":"","type":"address"},{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":true,"stateMutability":"payable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"}]';

    var network = ethers.providers.networks.ropsten;
    var provider = ethers.providers.getDefaultProvider(network); //ropsten测试网络

    //var provider = ethers.providers.getDefaultProvider();
    var contract = new ethers.Contract(contractAddress, abi, provider);

    function getCurrentPeriod() {
        contract.getCurrentPeriod().then(function (result) {
            console.log('currentPeriod is: ' + result);
            $("#current-period").text(result);
            while(result>1){
                getPrizeResult(--result);
            }
        });
    }
    function getPrizeResult(number) {
        contract.getPrizeResult(number).then(function (result) {
            console.log('PrizeResult is: ' + result);
            $("#prize-num").text(result[1]);
            $("#prize-address").text(result[0]);
            $("#block-height").text(result[2]);
            getTimestamp(number,result[0],result[1],parseInt(result[2]));
        });
    }

    function getTimestamp(period,address,prizeNum,blockHeight) {
        provider.getBlock(blockHeight).then(function(block) {
            console.log('blockInfo is: '+block.timestamp);
            var date = new Date();
            date.setTime(block.timestamp * 1000);
            console.log(date.toLocaleString());
            $("#prize-time").text(date.toLocaleString());
            var details = "https://ropsten.etherscan.io/address/"+address+"#internaltx"
            renderTable(period,date.toLocaleString() ,prizeNum,address,blockHeight ,details )
        });
    }
    getCurrentPeriod();

    
</script>

</body>
</html>